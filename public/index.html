<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Area Draw</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome-ie7.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.js"></script>
    <style type="text/css">
        #mapcontainer {
            display: flex;
        }

        #menu {
            width: 360px;
            padding: 5px;
        }

        #map {
            height: 100vh;
            /* width: calc(100% - 520px); */
            width: 100%;
        }

        .text-labels {
            background: rgba(255, 255, 255, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2px;
            font-size: 9px;
            border-radius: 36px;
            border: 1px solid red;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="mapcontainer">
        <div id="map"></div>
        <div id="menu" style="margin-bottom:200px">
            <div id="lotList"></div>
            <div id="inspector"></div>
        </div>
    </div>
    <script language="javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
    <script language="javascript" src="js/canvas-draw/jquery.canvasDrawer.js"></script>

    <script language="javascript">
        $(document).ready(function () {
            $('.draw-canvas[image-src]').canvasAreaDraw();
            loadMap();
        });
        const lotList = [];
        const lotData = {
            price: "$10,000",
            lotName: "Lot Name",
            landSize: "900m2",
            frontSize: "20m",
            precint: "Parkside Precinct",
            availability: "sold",
            latLangs: [],
            id: 0

        }
        const loadMap = function () {
            var map = L.map('map', {
                maxZoom: 24,
                minZoom: 1,
                crs: L.CRS.Simple
            }).setView([0, 0], 1);
            const mapBounds = map.getBounds(); console.log({ mapBounds })
            const [width, height] = [1080, 829]
            const mapDiv = $("#map")
            const [mapDivHeight, mapDivWidth] = [mapDiv.height(), mapDiv.width()];
            const scale = height / mapDivHeight * 6;

            const [natW, natH] = [width / scale, height / scale]
            // map.setMaxBounds(new L.LatLngBounds([0, 0], [width, height]));
            const drawnItems = L.featureGroup().addTo(map);

            map.addControl(new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    poly: {
                        allowIntersection: false
                    },
                    remove: false,
                    edit: false
                },

                draw: {
                    polyline: false,
                    rectangle: false,
                    circlemarker: false,
                    circle: false,
                    // marker: false,
                    simpleshape: true,
                },
            }));

            map.on(L.Draw.Event.CREATED, function (event) {
                var layer = event.layer;
                const latLangs = "";
                // if(typeof(layer.getLatLng))
                const data = { ...lotData }
                data.latLangs = layer.getLatLngs();
                const layerType = event.layerType;
                const info = "index info";
                const markerPos = layer.getBounds().getCenter();
                // var newMarker = new L.marker(markerPos);
                let iconText = new L.marker(markerPos, {
                    icon: L.divIcon({
                        iconSize: [16, 16],
                        className: 'text-labels',   // Set class for CSS styling
                        html: lotList.length + 1
                    })
                })
                const fGroup = L.featureGroup().addTo(drawnItems)
                layer.setStyle({
                    fillColor: "yellow",
                    color: "green"
                })
                layer.addTo(fGroup)
                // newMarker.addTo(fGroup)
                iconText.addTo(fGroup)
                const deleteButton = $('<button>delete</button>')
                const saveButton = $('<button>save</button>')
                fGroup.on("click", () => {
                    inspect(data, fGroup)
                    // fGroup.remove();
                })
                fGroup.bindPopup("<b> new info</b>");
                fGroup.on("mouseover", function (e) {
                    this.openPopup();
                })
                fGroup.on('mouseout', function (e) {
                    this.closePopup();
                });

                // fGroup.addLayer(layer)
                // fGroup.addLayer(newMarker)
                // drawnItems.addLayer(layer);
            });

            var imageUrl = 'https://kingbirdliving.com.au/wp-content/uploads/2022/05/lorekeet_sitemap_n.jpg'
            const mapCenter = map.getCenter();
            map.invalidateSize(true)
            console.log({ mapCenter })
            var imageBounds = [
                [0, 0],
                [natH, natW]
            ];

            var originPoint = map.latLngToContainerPoint(mapCenter);
            /* 2) Add the image pixel dimensions.
             * Positive x to go right (East).
             * Negative y to go up (North). 
             **/
            var nextCornerPoint = originPoint.add({ x: -natW, y: natH });
            /**
             *  3) Convert back into LatLng.
             */
            var nextCornerLatLng = map.containerPointToLatLng(nextCornerPoint);

            var imageOverlay = L.imageOverlay(imageUrl, [[natH / 2, natW / 2], nextCornerLatLng]).addTo(map);
            /**
             *  set zoom after adding image 
             **/
            map.setZoom(3)
            L.marker(mapCenter).addTo(map);

        }

        const inspect = (data, fGroup) => {

            const menuDiv = $("#inspector")
            const dataDiv = $(`
                        <div id="lot-lotName">${data.lotName}</div>
                        <div id="lot-landSize">${data.landSize}</div>
                        <div id="lot-frontSize">${data.frontSize}</div>
                        <div id="lot-precint">${data.precint}</div>
                        <div id="lot-availability">${data.availability}</div>
                        <div id="lot-price">${data.price}</div>
                    `);
            menuDiv.html(dataDiv)
            menuDiv.children("div").attr('contenteditable', 'true');
            const onDelete = () => {
                fGroup.remove();
            }
            const onSave = () => {
                const dt = ({
                    lotName: $("#lot-lotName").html(),
                    landSize: $("#lot-landSize").html(),
                    frontSize: $("#lot-frontSize").html(),
                    precint: $("#lot-precint").html(),
                    availability: $("#lot-availability").html(),
                    price: $("#lot-price").html(),
                })
                console.log({ f: fGroup._popup.getContent(), html: menuDiv.html() })
                const k = JSON.stringify(dt, null, 2);
                fGroup._popup.setContent(`<pre style="width: 200px; height:200px; overflow:auto;">${k}</pre>`)

            };
            deleteButton.on("click", onDelete)
            saveButton.on("click", onSave)
            menuDiv.append(deleteButton)
            menuDiv.append(saveButton)
        }
    </script>
</body>

</html>